const { PrismaClient } = require("@prisma/client");
const prisma = new PrismaClient();

/**
 * Script para crear datos de prueba del sistema de eliminaci√≥n de usuarios
 * Ejecutar con: node scripts/create-test-data.js
 */

// Funci√≥n para limpiar datos de prueba existentes
async function cleanupExistingTestData() {
  const testUserIds = [
    "test-basic-user-123",
    "test-artist-user-456",
    "test-collab-user-789",
    "test-curator-user-101",
    "test-subscribed-user-202",
  ];

  try {
    // Limpiar en orden para evitar problemas de FK
    for (const userId of testUserIds) {
      const user = await prisma.user.findUnique({ where: { id: userId } });
      if (user) {
        console.log(`   üóëÔ∏è Limpiando usuario existente: ${user.email}`);

        // Limpiar colaboraciones
        await prisma.muralColaborador.deleteMany({ where: { userId } });
        await prisma.salaColaborador.deleteMany({ where: { userId } });
        await prisma.userMuralFavorite.deleteMany({ where: { userId } });

        // Limpiar relaciones de salas
        const userSalas = await prisma.sala.findMany({
          where: { creadorId: userId },
          select: { id: true },
        });
        if (userSalas.length > 0) {
          await prisma.salaMural.deleteMany({
            where: { salaId: { in: userSalas.map((s) => s.id) } },
          });
        }

        // Limpiar contenido
        await prisma.mural.deleteMany({ where: { userId } });
        await prisma.sala.deleteMany({ where: { creadorId: userId } });

        // Limpiar datos de usuario
        await prisma.artist.deleteMany({ where: { userId } });
        await prisma.pushSubscription.deleteMany({ where: { userId } });
        await prisma.subscription.deleteMany({ where: { userId } });

        // Eliminar usuario
        await prisma.user.delete({ where: { id: userId } });
      }
    }
    console.log("‚úÖ Limpieza completada");
  } catch (error) {
    console.log("‚ö†Ô∏è Advertencia durante limpieza:", error.message);
    // Continuar con la creaci√≥n aunque falle la limpieza
  }
}

async function createTestData() {
  console.log(
    "üèóÔ∏è Iniciando creaci√≥n de datos de prueba para eliminaci√≥n de usuarios..."
  );

  try {
    // LIMPIAR DATOS EXISTENTES PRIMERO
    console.log("üßπ Limpiando datos de prueba existentes...");
    await cleanupExistingTestData();

    // 1. USUARIO B√ÅSICO SIN CONTENIDO
    console.log("üìù Creando usuario b√°sico sin contenido...");
    const basicUser = await prisma.user.upsert({
      where: { email: "test-basico@museo3d.com" },
      update: {},
      create: {
        id: "test-basic-user-123",
        name: "Usuario B√°sico Test",
        email: "test-basico@museo3d.com",
        role: "USER",
        emailVerified: new Date(),
        settings: {},
      },
    });
    console.log("‚úÖ Usuario b√°sico creado:", basicUser.email);

    // 2. USUARIO ARTISTA CON CONTENIDO P√öBLICO
    console.log("üé® Creando usuario artista con contenido p√∫blico...");
    const artistUser = await prisma.user.upsert({
      where: { email: "test-artista@museo3d.com" },
      update: {},
      create: {
        id: "test-artist-user-456",
        name: "Artista Test Gonz√°lez",
        email: "test-artista@museo3d.com",
        role: "ARTIST",
        emailVerified: new Date(),
        settings: {},
      },
    });

    // Crear perfil de artista
    await prisma.artist.upsert({
      where: { userId: artistUser.id },
      update: {},
      create: {
        userId: artistUser.id,
        bio: "Artista especializado en graffiti digital y murales urbanos. Participante activo en la comunidad.",
        especialidad: "Graffiti Digital",
        experiencia: "5 a√±os",
        website: "https://artistatest.com",
        instagram: "@artistatest",
      },
    });

    // Crear sala p√∫blica del artista
    const artistSala = await prisma.sala.create({
      data: {
        nombre: "Galer√≠a Urbana Test",
        descripcion: "Colecci√≥n de obras urbanas contempor√°neas para testing",
        publica: true,
        creadorId: artistUser.id,
        color: "#FF6B6B",
        tema: "urbano",
      },
    });

    // Crear murales p√∫blicos
    const mural1 = await prisma.mural.create({
      data: {
        titulo: "Revoluci√≥n Digital",
        descripcion:
          "Mural que representa la transformaci√≥n digital en el arte urbano",
        anio: 2024,
        tecnica: "Spray digital",
        publica: true,
        userId: artistUser.id,
        ubicacion: "Calle Test 123",
        url_imagen: "https://example.com/mural1.jpg",
      },
    });

    const mural2 = await prisma.mural.create({
      data: {
        titulo: "Naturaleza Perdida",
        descripcion: "Reflexi√≥n sobre el medio ambiente urbano",
        anio: 2024,
        tecnica: "Mixta",
        publica: true,
        userId: artistUser.id,
        ubicacion: "Plaza Test",
        url_imagen: "https://example.com/mural2.jpg",
      },
    });

    // Agregar murales a la sala
    await prisma.salaMural.createMany({
      data: [
        { salaId: artistSala.id, muralId: mural1.id },
        { salaId: artistSala.id, muralId: mural2.id },
      ],
    });

    console.log("‚úÖ Usuario artista creado con 1 sala y 2 murales p√∫blicos");

    // 3. USUARIO COLABORADOR ACTIVO
    console.log("üë• Creando usuario colaborador activo...");
    const collabUser = await prisma.user.upsert({
      where: { email: "test-colaborador@museo3d.com" },
      update: {},
      create: {
        id: "test-collab-user-789",
        name: "Colaborador Test L√≥pez",
        email: "test-colaborador@museo3d.com",
        role: "USER",
        emailVerified: new Date(),
        settings: {},
      },
    });

    // Crear sala propia del colaborador
    const collabSala = await prisma.sala.create({
      data: {
        nombre: "Espacio Colaborativo Test",
        descripcion: "Sala para pruebas de colaboraci√≥n",
        publica: false,
        creadorId: collabUser.id,
      },
    });

    // Agregar como colaborador en la sala del artista (evitar duplicados)
    try {
      await prisma.salaColaborador.create({
        data: {
          salaId: artistSala.id,
          userId: collabUser.id,
          rol: "curador",
        },
      });
    } catch (error) {
      if (error.code === "P2002") {
        console.log("   ‚ö†Ô∏è Colaboraci√≥n en sala ya existe, continuando...");
      } else {
        throw error;
      }
    }

    // Agregar como colaborador en murales (evitar duplicados)
    try {
      await prisma.muralColaborador.create({
        data: {
          muralId: mural1.id,
          userId: collabUser.id,
          rol: "colaborador",
        },
      });
    } catch (error) {
      if (error.code === "P2002") {
        console.log("   ‚ö†Ô∏è Colaboraci√≥n en mural 1 ya existe, continuando...");
      } else {
        throw error;
      }
    }

    try {
      await prisma.muralColaborador.create({
        data: {
          muralId: mural2.id,
          userId: collabUser.id,
          rol: "documentalista",
        },
      });
    } catch (error) {
      if (error.code === "P2002") {
        console.log("   ‚ö†Ô∏è Colaboraci√≥n en mural 2 ya existe, continuando...");
      } else {
        throw error;
      }
    }

    console.log(
      "‚úÖ Usuario colaborador creado con 1 sala propia y colaboraciones"
    );

    // 4. USUARIO CURADOR CON COLECCI√ìN PERSONAL
    console.log("üèõÔ∏è Creando usuario curador con colecci√≥n...");
    const curatorUser = await prisma.user.upsert({
      where: { email: "test-curador@museo3d.com" },
      update: {},
      create: {
        id: "test-curator-user-101",
        name: "Curador Test Mart√≠nez",
        email: "test-curador@museo3d.com",
        role: "CURATOR",
        emailVerified: new Date(),
        settings: {},
      },
    });

    // Agregar murales a favoritos (colecci√≥n personal) - evitar duplicados
    try {
      await prisma.userMuralFavorite.create({
        data: { userId: curatorUser.id, muralId: mural1.id },
      });
    } catch (error) {
      if (error.code === "P2002") {
        console.log("   ‚ö†Ô∏è Favorito mural 1 ya existe, continuando...");
      } else {
        throw error;
      }
    }

    try {
      await prisma.userMuralFavorite.create({
        data: { userId: curatorUser.id, muralId: mural2.id },
      });
    } catch (error) {
      if (error.code === "P2002") {
        console.log("   ‚ö†Ô∏è Favorito mural 2 ya existe, continuando...");
      } else {
        throw error;
      }
    }

    console.log("‚úÖ Usuario curador creado con colecci√≥n personal");

    // 5. USUARIO CON SUSCRIPCIONES Y NOTIFICACIONES
    console.log("üîî Creando usuario con suscripciones...");
    const subscribedUser = await prisma.user.upsert({
      where: { email: "test-suscrito@museo3d.com" },
      update: {},
      create: {
        id: "test-subscribed-user-202",
        name: "Usuario Suscrito Test",
        email: "test-suscrito@museo3d.com",
        role: "USER",
        emailVerified: new Date(),
        settings: {},
      },
    });

    // Crear suscripciones (usar upsert para evitar duplicados)
    await prisma.subscription.upsert({
      where: { userId_type: { userId: subscribedUser.id, type: "sala" } },
      update: {},
      create: { userId: subscribedUser.id, type: "sala" },
    });

    await prisma.subscription.upsert({
      where: { userId_type: { userId: subscribedUser.id, type: "obra" } },
      update: {},
      create: { userId: subscribedUser.id, type: "obra" },
    });

    // Crear suscripci√≥n push (simulada) - usar upsert
    await prisma.pushSubscription.upsert({
      where: { endpoint: "https://test-push-endpoint.com/test" },
      update: { userId: subscribedUser.id },
      create: {
        endpoint: "https://test-push-endpoint.com/test",
        p256dh: "test-p256dh-key",
        auth: "test-auth-key",
        userId: subscribedUser.id,
      },
    });

    console.log("‚úÖ Usuario con suscripciones creado");

    // RESUMEN FINAL
    console.log("\nüéâ ¬°Datos de prueba creados exitosamente!");
    console.log("\nüìä Resumen de usuarios de prueba:");
    console.log(
      "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    );
    console.log(
      "‚îÇ TIPO                ‚îÇ EMAIL                     ‚îÇ ID          ‚îÇ"
    );
    console.log(
      "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
    );
    console.log(
      "‚îÇ B√°sico              ‚îÇ test-basico@museo3d.com   ‚îÇ test-basic-user-123   ‚îÇ"
    );
    console.log(
      "‚îÇ Artista (p√∫blico)   ‚îÇ test-artista@museo3d.com  ‚îÇ test-artist-user-456  ‚îÇ"
    );
    console.log(
      "‚îÇ Colaborador         ‚îÇ test-colaborador@museo3d.com ‚îÇ test-collab-user-789 ‚îÇ"
    );
    console.log(
      "‚îÇ Curador             ‚îÇ test-curador@museo3d.com  ‚îÇ test-curator-user-101 ‚îÇ"
    );
    console.log(
      "‚îÇ Con suscripciones   ‚îÇ test-suscrito@museo3d.com ‚îÇ test-subscribed-user-202 ‚îÇ"
    );
    console.log(
      "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    );

    console.log("\nüß™ Casos de prueba disponibles:");
    console.log("1. Eliminaci√≥n b√°sica sin impacto");
    console.log("2. Eliminaci√≥n de artista con contenido p√∫blico");
    console.log("3. Eliminaci√≥n de colaborador activo");
    console.log("4. Eliminaci√≥n de curador con colecci√≥n");
    console.log("5. Eliminaci√≥n con suscripciones activas");

    console.log("\nüìù Para probar:");
    console.log("1. Abrir /admin/usuarios");
    console.log("2. Buscar cualquiera de los emails de arriba");
    console.log('3. Hacer clic en "Eliminar"');
    console.log("4. Observar diferentes an√°lisis de impacto");

    console.log("\nüßπ Para limpiar: node scripts/cleanup-test-data.js");
  } catch (error) {
    console.error("‚ùå Error creando datos de prueba:", error);
  } finally {
    await prisma.$disconnect();
  }
}

// Ejecutar solo si es llamado directamente
if (require.main === module) {
  createTestData();
}

module.exports = { createTestData };
